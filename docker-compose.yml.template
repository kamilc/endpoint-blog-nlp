version: '2'
services:
  luigid:
    image: endpoint-blog-pipeline/orchestrator:${VERSION}
    build:
      context: ./orchestrator
    command: luigid
    ports:
      - "8082:8082"

  minio:
    image: minio/minio:RELEASE.2019-04-23T23-50-36Z
    environment:
      - "MINIO_ACCESS_KEY=${S3_ACCESS_KEY}"
      - "MINIO_SECRET_KEY=${S3_SECRET_KEY}"
    volumes:
       - ./data:/data
       - ./minio-config:/root/.minio
    ports:
      - "9000:9000"

  notebooks:
    image: endpoint-blog-pipeline/notebooks:${VERSION}
    environment:
      - "S3_ACCESS_KEY=${S3_ACCESS_KEY}"
      - "S3_SECRET_KEY=${S3_SECRET_KEY}"
    volumes:
      - ./data:/usr/share/data/
      - ./notebooks:/notebooks
      - /var/run/docker.sock:/var/run/docker.sock
    build:
      context: ./orchestrator
    ports:
      - "8001:8001"
    command: jupyter lab --notebook-dir=/notebooks --ip 0.0.0.0 --allow-root --port 8001

  orchestrator:
    image: endpoint-blog-pipeline/orchestrator:${VERSION}
    depends_on:
      - luigid
    environment:
      - PROJECT_ROOT=$PWD
      - PIPELINE_VERSION=$VERSION
      - PYTHONPATH=/opt/orchestrator/
      - "S3_ACCESS_KEY=${S3_ACCESS_KEY}"
      - "S3_SECRET_KEY=${S3_SECRET_KEY}"
    volumes:
      - ./data:/usr/share/data/
      - /var/run/docker.sock:/var/run/docker.sock
    build:
      context: ./orchestrator
    command: luigi --module task Evaluate --scheduler-host luigid
